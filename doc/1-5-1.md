# Webスクレイピングロジックの実装計画

## HTMLの構造分析

test_dataフォルダのサンプルHTML（sample.html）を分析した結果、以下の構造を確認しました：

### 1. タイトル情報
- 位置: `<div class="info">` 内の `<h2>` タグ（182行目）
- 例: `[著者名] タイトル (作品名)`
- CSSセレクタ: `div.info > h2`

### 2. ページ数
- 位置: `<div class="gallery">` 内の `<div class="preview_thumb">` タグの数
- サンプルでは9ページ（252-278行目）
- CSSセレクタ: `div.gallery div.preview_thumb`

### 3. 画像URL
- 位置: 各 `<div class="preview_thumb">` 内の `<img>` タグの `data-src` 属性
- 例: `https://[domain]/[index]/[id]/[image_name].jpg`
- CSSセレクタ: `div.preview_thumb img[data-src]`

## 実装計画

### 1. スクレイピング用のユーティリティファイル作成

`src/renderer/utils/scraper.ts` を作成し、以下の機能を実装：

#### インターフェース定義
```typescript
interface ScrapedData {
  title: string;
  pageCount: number;
  imageUrls: string[];
}
```

#### スクレイピング関数
```typescript
async function scrapeGalleryData(html: string): Promise<ScrapedData> {
  // DOMParserを使用してHTMLをパース
  const parser = new DOMParser();
  const doc = parser.parseFromString(html, 'text/html');

  // タイトル取得
  const titleElement = doc.querySelector('div.info > h2');
  const title = titleElement?.textContent || '';

  // ページ数取得
  const thumbnails = doc.querySelectorAll('div.gallery div.preview_thumb');
  const pageCount = thumbnails.length;

  // 画像URL取得
  const imageUrls: string[] = [];
  thumbnails.forEach(thumb => {
    const img = thumb.querySelector('img[data-src]');
    if (img) {
      const dataSrc = img.getAttribute('data-src');
      if (dataSrc) {
        imageUrls.push(dataSrc);
      }
    }
  });

  return { title, pageCount, imageUrls };
}
```

### 2. DownloadDialogコンポーネントの作成

`src/renderer/components/DownloadDialog.tsx` を作成：

#### 主要機能
- URLの入力フィールド
- スクレイピング実行ボタン
- 結果表示エリア（タイトル、ページ数、画像URL一覧）
- ダウンロード進捗表示
- エラーハンドリング

#### コンポーネント構造
```typescript
interface DownloadDialogProps {
  isOpen: boolean;
  onClose: () => void;
}

const DownloadDialog: React.FC<DownloadDialogProps> = ({ isOpen, onClose }) => {
  const [url, setUrl] = useState('');
  const [scrapedData, setScrapedData] = useState<ScrapedData | null>(null);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);

  // スクレイピング処理
  const handleScrape = async () => {
    // URLからHTMLを取得
    // scrapeGalleryData関数を呼び出し
    // 結果をstateに保存
  };

  // ダウンロード処理
  const handleDownload = async () => {
    // 画像を順次ダウンロード
    // 進捗状況を表示
  };

  // UIをレンダリング
};
```

### 3. テストコードの作成

`src/renderer/utils/__tests__/scraper.test.ts` を作成：

#### テスト項目
1. **正常系テスト**
   - サンプルHTMLからタイトルが正しく取得できること
   - ページ数が正しくカウントされること
   - 画像URLが全て取得できること

2. **異常系テスト**
   - 必要な要素が存在しない場合のエラーハンドリング
   - 不正なHTML形式の場合の処理
   - 空のHTMLの場合の処理

```typescript
describe('scrapeGalleryData', () => {
  it('サンプルHTMLから正しくデータを抽出できること', async () => {
    const html = fs.readFileSync('test_data/sample.html', 'utf-8');
    const result = await scrapeGalleryData(html);

    expect(result.title).toBe('[著者名] タイトル (作品名)');
    expect(result.pageCount).toBe(9);
    expect(result.imageUrls).toHaveLength(9);
    expect(result.imageUrls[0]).toContain('https://images.asmhentai.com');
  });
});
```

### 4. 統合と動作確認

1. **コンポーネントの統合**
   - メインアプリケーションにDownloadDialogを組み込み
   - メニューまたはボタンから呼び出し可能にする

2. **E2Eテスト**
   - 実際のURLからのスクレイピングテスト
   - ダウンロード機能の動作確認
   - エラー時の適切なフィードバック確認

## 実装時の注意点

1. **セキュリティ**
   - XSS攻撃への対策（DOMParserの安全な使用）
   - 外部URLへのアクセス制限

2. **エラーハンドリング**
   - ネットワークエラーへの対処
   - HTML構造が変わった場合への対応
   - タイムアウト処理の実装

3. **パフォーマンス**
   - 大量の画像URLを扱う場合のメモリ管理
   - 非同期処理の適切な実装
   - プログレスバーによるユーザーフィードバック

## まとめ

この実装により、指定されたWebページから以下の情報を確実に抽出できるようになります：
- 日本語タイトル（h2タグから取得）
- ギャラリーのページ数（preview_thumbの数から算出）
- 各ページの画像URL（data-src属性から取得）

これらの情報を基に、画像の一括ダウンロード機能を実装することが可能となります。