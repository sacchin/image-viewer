# 実装計画：スクレイピングタイトルに基づくフォルダ作成と画像保存

## 現在の実装状況
- スクレイピングで取得されるタイトル（`ScrapedData.title`）
- 設定画面で保存されているダウンロードパス（`settings.defaultDownloadPath`）
- 現在はジョブIDをフォルダ名として使用（例：`job-1234567890-1`）

## 実装手順

### 1. **src/main/ipc.ts の修正**
- `processDownloadJob` 関数を更新
  - 現在の `jobId` フォルダ作成から、タイトルベースのフォルダ作成に変更
  - タイトルからファイルシステムに安全なフォルダ名を生成
  - 既存フォルダの確認と処理

### 2. **フォルダ名生成ロジックの実装**
- タイトルのサニタイズ処理：
  - 特殊文字の削除・置換（`/`, `\`, `:`, `*`, `?`, `"`, `<`, `>`, `|`）
  - 空白の処理（アンダースコア置換）
  - 長すぎるタイトルの切り詰め（最大255文字）
  - 空のタイトルへの対処

### 3. **既存フォルダのハンドリング**
- 同名フォルダが存在する場合：
  - そのフォルダをそのまま使用（上書きしない）
  - 既存の画像ファイルとの重複を避けるための採番処理

### 4. **ファイル名生成の更新**
- 現在：`{sanitized_title}_{連番}.{拡張子}`
- フォルダごとに整理されるため、シンプルな連番に変更可能
  - 例：`001.jpg`, `002.jpg`

### 5. **エラーハンドリング**
- フォルダ作成失敗時のフォールバック
- 書き込み権限がない場合の対処
- ログメッセージの追加

## 変更箇所の詳細

```typescript
// src/main/ipc.ts の processDownloadJob 関数内

// 現在のコード（行 184-185）:
const downloadPath = settingsManager.getSettings().defaultDownloadPath;
const jobDir = path.join(downloadPath, jobId);

// 変更後:
const downloadPath = settingsManager.getSettings().defaultDownloadPath;
const safeFolderName = sanitizeFolderName(job.title || 'Untitled');
const jobDir = path.join(downloadPath, safeFolderName);

// サニタイズ関数の追加
function sanitizeFolderName(title: string): string {
  // Windowsで禁止されている文字を置換
  let safe = title.replace(/[<>:"/\\|?*]/g, '_');
  // 連続するスペースやアンダースコアを単一のアンダースコアに
  safe = safe.replace(/[\s_]+/g, '_');
  // 先頭と末尾の空白・ピリオドを削除
  safe = safe.trim().replace(/^\.+|\.+$/g, '');
  // 最大長制限
  if (safe.length > 200) {
    safe = safe.substring(0, 200);
  }
  // 空の場合のフォールバック
  return safe || `gallery_${Date.now()}`;
}
```

## テストケース
1. 通常のタイトル → 正常にフォルダ作成
2. 特殊文字を含むタイトル → サニタイズされて作成
3. 空のタイトル → デフォルト名で作成
4. 既存フォルダがある場合 → 既存フォルダを使用
5. 長すぎるタイトル → 切り詰めて作成

## 影響範囲
- メインプロセスのダウンロード処理のみ
- UI側の変更は不要
- 既存のジョブ追跡機能は維持

## 実装時の注意点

### クロスプラットフォーム対応
- Windows、macOS、Linuxで異なるファイルシステム制限を考慮
- 最も制限的なWindows基準でサニタイズ

### 既存フォルダとの共存
- 同じタイトルの作品を再ダウンロードする場合の考慮
- ファイル番号の開始位置を既存ファイル数から計算

### ユーザビリティ
- フォルダ名が人間に理解しやすい形で生成される
- 元のタイトルの意味を可能な限り保持

## 今後の拡張可能性
1. フォルダ名のカスタマイズオプション
2. 重複時の番号付けオプション（例：`タイトル (2)`）
3. メタデータファイルの自動生成
4. ダウンロード履歴の管理機能